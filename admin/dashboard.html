<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>TEAM VAJRA - Blog Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/assets/club-logo.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="nav">
            <div class="brand">
                <img src="/assets/club-logo.jpg" alt="Team Vajra logo">
                <div>
                    <div class="title">TEAM VAJRA</div>
                    <div class="subtitle">Blog Dashboard</div>
                </div>
            </div>
            <div class="nav-links">
                <a href="/blog.html">View Blog</a>
                <a href="/admin/editor.html" class="btn-new">+ New Post</a>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </header>

    <!-- User Info -->
    <div class="user-bar">
        <span id="userInfo">Loading...</span>
        <span id="userRole" class="role-badge"></span>
    </div>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="dashboard-header">
            <h1>Blog Posts</h1>
            <a href="/admin/editor.html" class="btn-primary">+ Create New Post</a>
        </div>

        <div class="blog-list" id="blogList">
            <div class="loading">Loading blogs...</div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 TEAM VAJRA. All Rights Reserved. | Admin Dashboard</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChvColRVokPBbAOiXv8P26ScRyDxPJI2w",
            authDomain: "team-vajra.firebaseapp.com",
            projectId: "team-vajra",
            storageBucket: "team-vajra.firebasestorage.app",
            messagingSenderId: "865557876116",
            appId: "1:865557876116:web:9f0ee78cee3c157df75381"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Check authentication
        const session = sessionStorage.getItem('vajraUser');
        if (!session) {
            window.location.href = '/login.html';
        }

        const user = JSON.parse(session);
        const isAdmin = user.role === 'admin';

        // Display user info
        document.getElementById('userInfo').textContent = `Welcome, ${user.name}`;
        document.getElementById('userRole').textContent = user.role.toUpperCase();
        document.getElementById('userRole').classList.add(isAdmin ? 'admin' : 'member');

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('vajraUser');
            window.location.href = '/login.html';
        });

        // Load blogs
        async function loadBlogs() {
            const blogList = document.getElementById('blogList');

            try {
                const blogsRef = collection(db, 'blogs');
                const q = query(blogsRef, orderBy('publishedAt', 'desc'));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    blogList.innerHTML = `
            <div class="empty-state">
              <h3>No blog posts yet</h3>
              <p>Click "Create New Post" to write your first blog!</p>
            </div>
          `;
                    return;
                }

                let html = '';
                snapshot.forEach((docSnap) => {
                    const blog = docSnap.data();
                    const blogId = docSnap.id;
                    const date = blog.publishedAt ? new Date(blog.publishedAt).toLocaleDateString('en-IN', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    }) : 'Draft';

                    const canEdit = isAdmin || blog.authorEmail === user.email;
                    const canDelete = isAdmin;

                    html += `
            <div class="blog-card">
              <div class="blog-info">
                <h3>${blog.title || 'Untitled'}</h3>
                <div class="blog-meta">
                  <span class="date">${date}</span>
                  <span class="author">By ${blog.authorName || 'Unknown'}</span>
                  <span class="category">${blog.category || 'General'}</span>
                  <span class="status ${blog.status === 'published' ? 'published' : 'draft'}">${blog.status || 'draft'}</span>
                </div>
                <p class="excerpt">${blog.excerpt || ''}</p>
              </div>
              <div class="blog-actions">
                ${canEdit ? `<a href="/admin/editor.html?id=${blogId}" class="btn-edit">Edit</a>` : ''}
                ${canDelete ? `<button class="btn-delete" data-id="${blogId}">Delete</button>` : ''}
                <a href="/blog.html#${blog.slug || blogId}" class="btn-view" target="_blank">View</a>
              </div>
            </div>
          `;
                });

                blogList.innerHTML = html;

                // Add delete handlers
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        if (confirm('Are you sure you want to delete this blog post? This cannot be undone.')) {
                            try {
                                await deleteDoc(doc(db, 'blogs', id));
                                loadBlogs(); // Refresh list
                            } catch (err) {
                                alert('Failed to delete: ' + err.message);
                            }
                        }
                    });
                });

            } catch (err) {
                console.error('Error loading blogs:', err);
                blogList.innerHTML = `<div class="error">Failed to load blogs. Please try again.</div>`;
            }
        }

        loadBlogs();
    </script>
</body>

</html>